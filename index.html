<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- Base & Light Mode --- */
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s; 
            background-color: #f8fafc;
            color: #1f2937; 
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e2e8f0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .main-card, .auth-card { 
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid #e5e7eb; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            transition: all 0.3s; 
        }
        .task-item, .list-item { 
            animation: fadeInUp 0.4s ease-out; 
        }
        .task-item.completed span.task-text { 
            text-decoration: line-through; 
            color: #9ca3af; 
        }
        .list-item.active { 
            background-color: #eef2ff; 
            color: #1e3a8a; 
            font-weight: 600; 
        }
        h2.list-header { 
            color: #1e3a8a; 
        }
        .list-item {
             color: #1e40af;
        }
        
        #auth-container h2 { color: #1f2937;}
        #auth-container label { color: #4b5563;}
        #auth-container p { color: #4b5563;}

        input {
             color: #111827;
             background-color: #f9fafb;
        }
        input::placeholder { color: #9ca3af !important; }

        input[type="date"], input[type="datetime-local"] {
            color-scheme: light;
        }

        /* --- Dark Mode --- */
        .dark body { 
            background-color: #0f172a; 
            color: #d1d5db;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .dark .main-card, .dark .auth-card { 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .dark .task-item.completed span.task-text { 
            color: #6b7280; 
        }
        .dark .list-item.active { 
            background-color: #3730a3; 
            color: #ffffff; 
        }
        .dark h2.list-header, .dark .list-item { 
            color: #e5e7eb; 
        }
        
        .dark #auth-container h2 { color: #ffffff;}
        .dark #auth-container label { color: #d1d5db;}
        .dark #auth-container p { color: #9ca3af;}

        .dark input {
            color: #e5e7eb;
            background-color: #1e293b;
        }
        .dark input::placeholder { color: #6b7280 !important; }
        
        .dark input[type="date"], .dark input[type="datetime-local"] {
            color-scheme: dark;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="antialiased">

    <!-- Auth Views -->
    <div id="auth-container">
        <div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4">
            <div class="auth-card max-w-md w-full p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center mb-6">Welcome Back!</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium">Email</label>
                        <input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium">Password</label>
                        <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="login-error" class="text-red-500 text-sm mb-4 h-5"></p>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Log In</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Don't have an account? <a href="#" id="show-signup" class="font-medium text-indigo-600 hover:text-indigo-500">Sign up</a>
                </p>
            </div>
        </div>
        <div id="signup-view" class="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 p-4 hidden">
             <div class="auth-card max-w-md w-full p-8 rounded-xl shadow-lg">
                <h2 class="text-3xl font-bold text-center mb-6">Create Account</h2>
                <form id="signup-form">
                     <div class="mb-4">
                        <label for="signup-name" class="block text-sm font-medium">Display Name</label>
                        <input type="text" id="signup-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium">Email</label>
                        <input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium">Password</label>
                        <input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <p id="signup-error" class="text-red-500 text-sm mb-4 h-5"></p>
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Sign Up</button>
                </form>
                <p class="mt-4 text-center text-sm">
                    Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Log in</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden flex flex-col min-h-screen">
        <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm shadow-sm sticky top-0 z-20 border-b border-slate-200 dark:border-slate-800">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                     <i data-lucide="check-circle-2" class="w-8 h-8 text-indigo-600"></i>
                    <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Task Manager</h1>
                </div>
                <div class="flex items-center space-x-4 md:space-x-6">
                    <a href="#" id="nav-tasks" class="nav-link font-medium">Tasks</a>
                    <a href="#" id="nav-dashboard" class="nav-link font-medium">Dashboard</a>
                    <a href="#" id="nav-settings" class="nav-link font-medium">Settings</a>
                    <div class="flex items-center space-x-4">
                        <span id="user-display-name" class="hidden sm:block text-sm font-medium text-slate-600 dark:text-slate-300"></span>
                        <button id="theme-toggle" class="text-gray-600 dark:text-gray-300"></button>
                        <button id="logout-btn" class="text-gray-600 dark:text-gray-300 hover:text-indigo-500 dark:hover:text-indigo-400" title="Logout"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-grow w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 mt-4">
            <div id="tasks-view">
                <div class="w-full main-card rounded-2xl grid md:grid-cols-3 lg:grid-cols-4 gap-8 p-6 md:p-8">
                    <aside class="md:col-span-1 lg:col-span-1 border-r-0 md:border-r md:pr-8 dark:border-slate-700">
                        <h2 class="list-header text-xl font-bold mb-4">My Lists</h2>
                        <ul id="section-list" class="space-y-2 mb-4"></ul>
                        <button id="add-list-btn" class="w-full bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-300 font-semibold py-2 px-4 rounded-lg transition inline-flex items-center justify-center gap-2 border border-gray-200 dark:border-slate-600">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i><span>New List</span>
                        </button>
                    </aside>
                    <section class="md:col-span-2 lg:col-span-3">
                        <header class="mb-6"><h1 id="list-title" class="text-3xl md:text-4xl font-bold"></h1></header>
                        <div id="task-content">
                            <form id="task-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <input type="text" id="task-input" placeholder="Task description" class="sm:col-span-2 p-3 border border-gray-200 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <input type="datetime-local" id="task-start" class="p-3 border border-gray-200 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <input type="datetime-local" id="task-end" class="p-3 border border-gray-200 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <button type="submit" class="sm:col-span-2 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition">Add Task</button>
                            </form>
                            <div id="task-list-container" class="bg-gray-50 dark:bg-slate-800/50 rounded-lg "><ul id="task-list"></ul></div>
                            <div id="empty-state" class="hidden text-center py-12">
                                <i data-lucide="clipboard-check" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-500"></i>
                                <h3 class="mt-4 text-xl font-semibold text-gray-600 dark:text-gray-300">All tasks completed!</h3>
                            </div>
                            <div class="mt-6 text-center">
                                <button id="clear-all-btn" class="bg-red-50 dark:bg-red-900/50 text-red-600 dark:text-red-300 font-medium py-2 px-4 rounded-lg hover:bg-red-100 dark:hover:bg-red-900 transition">Clear All</button>
                            </div>
                        </div>
                        <div id="initial-prompt" class="hidden text-center py-12">
                            <i data-lucide="folder-plus" class="w-16 h-16 mx-auto text-gray-400"></i>
                            <h3 class="mt-4 text-xl font-semibold">Create a list to begin!</h3>
                        </div>
                    </section>
                </div>
            </div>
            <div id="dashboard-view" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-8">
                        <div class="main-card rounded-2xl p-6">
                            <h2 class="text-2xl font-bold">Task Status Overview</h2>
                            <div class="h-64 flex items-center justify-center"><canvas id="tasks-pie-chart"></canvas></div>
                        </div>
                        <div class="main-card rounded-2xl p-6">
                            <h2 class="text-2xl font-bold">Tasks per List</h2>
                            <div class="h-64 flex items-center justify-center"><canvas id="tasks-bar-chart"></canvas></div>
                        </div>
                    </div>
                    <div class="main-card rounded-2xl p-6">
                        <h2 class="text-2xl font-bold">Search Tasks by Date</h2>
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <input type="date" id="search-start-date" class="w-full p-2 border rounded border-gray-200 dark:border-slate-600">
                            <input type="date" id="search-end-date" class="w-full p-2 border rounded border-gray-200 dark:border-slate-600">
                            <button id="search-tasks-btn" class="bg-indigo-600 text-white px-4 py-2 rounded">Search</button>
                        </div>
                        <div id="search-results" class="no-scrollbar" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
            <div id="settings-view" class="hidden">
                <div class="max-w-2xl mx-auto main-card rounded-2xl p-8">
                    <h2 class="text-3xl font-bold">Settings</h2>
                    <div class="space-y-8">
                         <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                            <label for="display-name" class="md:col-span-1 text-sm font-medium text-gray-700 dark:text-gray-300">Display Name</label>
                            <div class="md:col-span-2 flex gap-2">
                                <input type="text" id="display-name" class="flex-grow block w-full p-2 border border-gray-300 dark:border-slate-600 rounded-md">
                                <button id="save-name-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 items-center gap-4">
                            <h3 class="md:col-span-1 text-sm font-medium text-gray-700 dark:text-gray-300">Password</h3>
                            <div class="md:col-span-2">
                                <button id="change-password-btn" class="w-full bg-gray-200 dark:bg-slate-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-md hover:bg-gray-300 dark:hover:bg-slate-600">Send Password Reset Email</button>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 dark:border-slate-700"></div>
                        <div>
                            <h3 class="text-lg font-medium">Data Management</h3>
                             <button id="export-data-btn" class="w-full bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 py-2 px-4 rounded-md hover:bg-green-200 dark:hover:bg-green-900/80 mb-4">Export My Data as JSON</button>
                            <button id="delete-account-btn" class="w-full bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 py-2 px-4 rounded-md hover:bg-red-200 dark:hover:bg-red-900/80">Delete My Account and All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer id="app-footer" class="text-center py-4 text-sm text-slate-500 dark:text-slate-400 border-t border-slate-200 dark:border-slate-800 mt-auto">
            Created by SHUBHANKAR SINGH
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            deleteUser,
            updateProfile,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB4e3PY_Kd02XdFRDa9GkXm7fZRjLv-kDs",
          authDomain: "task-manager-ed4dd.firebaseapp.com",
          projectId: "task-manager-ed4dd",
          storageBucket: "task-manager-ed4dd.appspot.com",
          messagingSenderId: "200206867875",
          appId: "1:200206867875:web:5642d971155e1d2c4c8e16"
        };
        
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(finalFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            if (finalFirebaseConfig.apiKey === "PASTE_YOUR_API_KEY_HERE") {
                document.body.innerHTML = `<div class="text-red-500 p-8 text-center">CRITICAL ERROR: Firebase is not configured. Please paste your firebaseConfig object into the task-manager.html file.</div>`;
                return;
            }

            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            let pieChart = null;
            let barChart = null;
            let unsubscribeLists = () => {};
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    initializeAppLogic(user);
                } else {
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    unsubscribeLists();
                    if (pieChart) pieChart.destroy();
                    if (barChart) barChart.destroy();
                    pieChart = null;
                    barChart = null;
                }
                lucide.createIcons();
            });
            
            const loginView = document.getElementById('login-view');
            const signupView = document.getElementById('signup-view');
            document.getElementById('show-signup').addEventListener('click', e => { e.preventDefault(); loginView.classList.add('hidden'); signupView.classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', e => { e.preventDefault(); signupView.classList.add('hidden'); loginView.classList.remove('hidden'); });

            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', async e => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                try {
                    errorEl.textContent = '';
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    errorEl.textContent = error.message.replace('Firebase: ','');
                }
            });

            const signupForm = document.getElementById('signup-form');
            signupForm.addEventListener('submit', async e => {
                e.preventDefault();
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const errorEl = document.getElementById('signup-error');
                try {
                    errorEl.textContent = '';
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: name });
                } catch (error) {
                    errorEl.textContent = error.message.replace('Firebase: ','');
                }
            });

            function initializeAppLogic(user) {
                const userId = user.uid;
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                let state = { lists: {}, activeList: null };
                
                document.getElementById('user-display-name').textContent = user.displayName || user.email;
                const sectionList = document.getElementById('section-list');
                const listTitle = document.getElementById('list-title');
                const taskList = document.getElementById('task-list');
                const taskForm = document.getElementById('task-form');
                const addListBtn = document.getElementById('add-list-btn');
                const clearAllBtn = document.getElementById('clear-all-btn');
                const logoutBtn = document.getElementById('logout-btn');

                const navLinks = document.querySelectorAll('.nav-link');
                const views = {
                    'nav-tasks': document.getElementById('tasks-view'),
                    'nav-dashboard': document.getElementById('dashboard-view'),
                    'nav-settings': document.getElementById('settings-view')
                };

                const switchView = (targetId) => {
                    Object.values(views).forEach(v => v.classList.add('hidden'));
                    views[targetId].classList.remove('hidden');
                    navLinks.forEach(link => {
                        link.classList.toggle('text-indigo-600', link.id === targetId);
                        link.classList.toggle('dark:text-indigo-400', link.id === targetId);
                        link.classList.toggle('text-gray-600', link.id !== targetId);
                        link.classList.toggle('dark:text-gray-300', link.id !== targetId);
                    });
                    if(targetId === 'nav-dashboard') renderDashboard();
                };
                
                navLinks.forEach(link => link.addEventListener('click', e => {
                    e.preventDefault();
                    switchView(e.currentTarget.id);
                }));

                unsubscribeLists = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        state.lists = data.lists || {};
                        state.activeList = data.activeList || Object.keys(state.lists)[0] || null;
                    } else {
                        state = { lists: { 'General': [] }, activeList: 'General' };
                        setDoc(userDocRef, state);
                    }
                    fullRender();
                    if (document.getElementById('dashboard-view').offsetParent !== null) {
                        renderDashboard();
                    }
                });

                const saveData = () => setDoc(userDocRef, state, { merge: true });
                const fullRender = () => { renderLists(); renderTasks(); };

                function renderLists() {
                    sectionList.innerHTML = '';
                    const listNames = Object.keys(state.lists);
                    if (listNames.length === 0) return;
                    listNames.forEach(listName => {
                        const li = document.createElement('li');
                        li.className = `list-item rounded-lg cursor-pointer p-2 ${listName === state.activeList ? 'active' : ''}`;
                        li.textContent = listName;
                        li.dataset.listName = listName;
                        sectionList.appendChild(li);
                    });
                }
                
                function renderTasks() {
                    const taskContent = document.getElementById('task-content');
                    const initialPrompt = document.getElementById('initial-prompt');
                    const emptyState = document.getElementById('empty-state');
                    const taskListContainer = document.getElementById('task-list-container');

                    if (!state.activeList || !state.lists[state.activeList]) {
                        taskContent.classList.add('hidden');
                        initialPrompt.classList.remove('hidden');
                        return;
                    }
                    taskContent.classList.remove('hidden');
                    initialPrompt.classList.add('hidden');

                    listTitle.textContent = state.activeList;
                    const currentTasks = state.lists[state.activeList] || [];
                    taskList.innerHTML = '';
                    
                    if (currentTasks.length === 0) {
                        emptyState.classList.remove('hidden');
                        taskListContainer.classList.add('hidden');
                        clearAllBtn.classList.add('hidden');
                    } else {
                         emptyState.classList.add('hidden');
                        taskListContainer.classList.remove('hidden');
                        clearAllBtn.classList.remove('hidden');
                        currentTasks.forEach((task) => {
                           const li = document.createElement('li');
                            li.className = `task-item flex items-start sm:items-center justify-between p-4 border-b border-gray-100 dark:border-slate-700 flex-col sm:flex-row gap-2 ${task.completed ? 'completed' : ''}`;
                            li.dataset.id = task.id;
                            const duration = task.start && task.end ? `${new Date(task.start).toLocaleString()} - ${new Date(task.end).toLocaleString()}` : 'No duration set';
                            li.innerHTML = `
                                <div class="flex items-center gap-3">
                                    <button class="toggle-btn w-6 h-6 flex-shrink-0 flex items-center justify-center rounded-full border-2 ${task.completed ? 'bg-indigo-600 border-indigo-600' : 'border-gray-400'}"></button>
                                    <div>
                                        <span class="task-text text-gray-800 dark:text-gray-200">${task.text}</span>
                                        <p class="text-xs text-gray-500">${duration}</p>
                                    </div>
                                </div>
                                <button class="delete-btn text-gray-400 hover:text-red-500 self-end sm:self-center"><i data-lucide="x" class="pointer-events-none"></i></button>
                            `;
                            taskList.appendChild(li);
                        });
                    }
                    lucide.createIcons();
                }

                addListBtn.addEventListener('click', () => {
                    const newListName = prompt("New list name:");
                    if (newListName && !state.lists[newListName]) {
                        state.lists[newListName] = [];
                        state.activeList = newListName;
                        saveData();
                    }
                });

                sectionList.addEventListener('click', e => {
                    if (e.target.tagName === 'LI') {
                        state.activeList = e.target.dataset.listName;
                        saveData();
                    }
                });
                
                taskForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const text = document.getElementById('task-input').value;
                    const start = document.getElementById('task-start').value;
                    const end = document.getElementById('task-end').value;
                    if (text && state.activeList) {
                        const newTask = { id: Date.now().toString(), text, start, end, completed: false };
                        if (!state.lists[state.activeList]) state.lists[state.activeList] = [];
                        state.lists[state.activeList].push(newTask);
                        saveData();
                        taskForm.reset();
                    }
                });
                
                taskList.addEventListener('click', e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const taskId = button.closest('.task-item').dataset.id;
                    const taskIndex = state.lists[state.activeList].findIndex(t => t.id === taskId);
                    if (taskIndex === -1) return;
                    if (button.classList.contains('toggle-btn')) {
                        state.lists[state.activeList][taskIndex].completed = !state.lists[state.activeList][taskIndex].completed;
                    } else if (button.classList.contains('delete-btn')) {
                        state.lists[state.activeList].splice(taskIndex, 1);
                    }
                    saveData();
                });

                clearAllBtn.addEventListener('click', () => {
                    if (confirm(`Delete all tasks in "${state.activeList}"?`)) {
                        state.lists[state.activeList] = [];
                        saveData();
                    }
                });

                logoutBtn.addEventListener('click', () => signOut(auth));

                function renderDashboard() {
                    const allTasks = Object.values(state.lists || {}).flat();
                    const completed = allTasks.filter(t => t.completed).length;
                    const pending = allTasks.length - completed;
                    const isDarkMode = document.documentElement.classList.contains('dark');
                    const textColor = isDarkMode ? '#e5e7eb' : '#374151';

                    // --- Pie Chart ---
                    const chartCtx = document.getElementById('tasks-pie-chart').getContext('2d');
                    if(pieChart) pieChart.destroy();
                    pieChart = new Chart(chartCtx, {
                        type: 'doughnut', // Changed to doughnut for a modern look
                        data: {
                            labels: ['Completed', 'Pending'],
                            datasets: [{
                                data: [completed, pending],
                                backgroundColor: ['#4ade80', '#fbbf24'],
                                borderColor: [isDarkMode ? '#0f172a' : '#f8fafc'],
                                borderWidth: 4,
                                hoverOffset: 8
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: textColor,
                                        font: {
                                            size: 14,
                                            family: "'Inter', sans-serif"
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // --- Bar Chart ---
                    const barChartCtx = document.getElementById('tasks-bar-chart').getContext('2d');
                    if(barChart) barChart.destroy();

                    const listLabels = Object.keys(state.lists || {});
                    const taskCounts = listLabels.map(listName => (state.lists[listName] || []).length);

                    barChart = new Chart(barChartCtx, {
                        type: 'bar',
                        data: {
                            labels: listLabels,
                            datasets: [{
                                label: '# of Tasks',
                                data: taskCounts,
                                backgroundColor: 'rgba(99, 102, 241, 0.6)',
                                borderColor: 'rgba(99, 102, 241, 1)',
                                borderWidth: 1,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        color: textColor
                                    },
                                    grid: {
                                        color: isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: textColor
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
                
                document.getElementById('search-tasks-btn').addEventListener('click', () => {
                    const start = document.getElementById('search-start-date').valueAsNumber;
                    const end = document.getElementById('search-end-date').valueAsNumber;
                    const resultsContainer = document.getElementById('search-results');
                    resultsContainer.innerHTML = '';
                    
                    if (!start || !end) {
                        resultsContainer.innerHTML = `<p class="p-2 text-red-500">Please select both a start and end date.</p>`;
                        return;
                    }

                    const allTasks = Object.values(state.lists).flat();
                    const results = allTasks.filter(task => {
                        const taskStart = new Date(task.start).getTime();
                        return taskStart >= start && taskStart <= end;
                    });
                    
                    if (results.length > 0) {
                        results.forEach(task => {
                            resultsContainer.innerHTML += `<div class="p-3 border-b border-gray-100 dark:border-slate-700">${task.text}</div>`;
                        });
                    } else {
                        resultsContainer.innerHTML = `<p class="p-3">No tasks found in this date range.</p>`;
                    }
                });
                
                // --- SETTINGS LOGIC ---
                const displayNameInput = document.getElementById('display-name');
                displayNameInput.value = user.displayName || '';

                document.getElementById('save-name-btn').addEventListener('click', async () => {
                    const newName = displayNameInput.value.trim();
                    if (newName && newName !== user.displayName) {
                        try {
                            await updateProfile(user, { displayName: newName });
                            document.getElementById('user-display-name').textContent = newName;
                            alert("Display name updated!");
                        } catch (error) {
                            alert("Error updating name: " + error.message);
                        }
                    }
                });

                document.getElementById('change-password-btn').addEventListener('click', async () => {
                    try {
                        await sendPasswordResetEmail(auth, user.email);
                        alert("Password reset email sent to " + user.email);
                    } catch (error) {
                        alert("Error sending email: " + error.message);
                    }
                });

                document.getElementById('export-data-btn').addEventListener('click', () => {
                    const dataStr = JSON.stringify(state.lists, null, 2);
                    const dataBlob = new Blob([dataStr], {type: "application/json"});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.download = 'task-manager-data.json';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                });

                document.getElementById('delete-account-btn').addEventListener('click', async () => {
                    if (confirm("Are you sure? This will permanently delete your account and all your task data.")) {
                        try {
                            await setDoc(userDocRef, {}); 
                            await deleteUser(user);
                            alert("Account deleted successfully.");
                        } catch (error) {
                            alert("Error deleting account. You may need to log in again.\n" + error.message);
                        }
                    }
                });
            }

            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = `<i data-lucide="sun" class="w-6 h-6"></i>`;
            const moonIcon = `<i data-lucide="moon" class="w-6 h-6"></i>`;
            
            const updateThemeIcon = (theme) => {
                themeToggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
                lucide.createIcons();
            }
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.classList.toggle('dark', savedTheme === 'dark');
            updateThemeIcon(savedTheme);
            themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                const newTheme = isDark ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);

                // FIX: Rerender dashboard on theme change if it's visible
                if (!document.getElementById('dashboard-view').classList.contains('hidden')) {
                    const user = auth.currentUser;
                    if (user) {
                        // This is a bit of a hack, but we need the state data which is inside the main logic scope
                        // A better approach would be a more robust state management solution
                        onSnapshot(doc(db, `artifacts/${appId}/users/${user.uid}`), (docSnap) => {
                             if (docSnap.exists()) {
                                // Re-rendering dashboard with fresh data and new theme colors
                                const isDarkMode = document.documentElement.classList.contains('dark');
                                const textColor = isDarkMode ? '#e5e7eb' : '#374151';
                                const state = docSnap.data();

                                const allTasks = Object.values(state.lists || {}).flat();
                                const completed = allTasks.filter(t => t.completed).length;
                                const pending = allTasks.length - completed;

                                if(pieChart) {
                                    pieChart.data.datasets[0].borderColor = [isDarkMode ? '#0f172a' : '#f8fafc'];
                                    pieChart.options.plugins.legend.labels.color = textColor;
                                    pieChart.update();
                                }
                                if(barChart) {
                                    barChart.options.scales.y.ticks.color = textColor;
                                    barChart.options.scales.x.ticks.color = textColor;
                                    barChart.options.scales.y.grid.color = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                                    barChart.update();
                                }
                             }
                        });
                    }
                }
            });

            lucide.createIcons();
        });
    </script>
</body>
</html>

